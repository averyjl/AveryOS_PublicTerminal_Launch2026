name: Auto Push Capsule Updates

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: CapsuleVerifier - Verify VaultChain SHA Integrity
        run: |
          echo "ðŸ”’ Running CapsuleVerifier..."
          
          # Extract VaultChain Anchor from both scripts
          INSTALL_SHA=$(grep -oP 'VaultChain Anchor: \K[a-f0-9]{128}' install.sh || echo "")
          DEPLOY_SHA=$(grep -oP 'VaultChain Anchor: \K[a-f0-9]{128}' deploy.sh || echo "")
          
          # Verify both SHAs exist
          if [ -z "$INSTALL_SHA" ]; then
            echo "âŒ ERROR: VaultChain Anchor not found in install.sh"
            exit 1
          fi
          
          if [ -z "$DEPLOY_SHA" ]; then
            echo "âŒ ERROR: VaultChain Anchor not found in deploy.sh"
            exit 1
          fi
          
          echo "Install SHA: ${INSTALL_SHA:0:32}...${INSTALL_SHA: -32}"
          echo "Deploy SHA:  ${DEPLOY_SHA:0:32}...${DEPLOY_SHA: -32}"
          
          # Verify SHAs match
          if [ "$INSTALL_SHA" != "$DEPLOY_SHA" ]; then
            echo "âŒ ERROR: VaultChain Anchor mismatch between install.sh and deploy.sh"
            echo "  Install: $INSTALL_SHA"
            echo "  Deploy:  $DEPLOY_SHA"
            exit 1
          fi
          
          echo "âœ“ CapsuleVerifier: VaultChain integrity verified across both install scripts"

      - name: Generate Capsule Metadata
        run: |
          echo "ðŸ“¦ Generating capsule metadata..."
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Note: Capsule values are synchronized with package.json and averyos.config
          cat > capsule_metadata.json << EOF
          {
            "capsule": {
              "name": "AveryOS_PublicTerminal_Launch2026",
              "uri": "capsule://JasonLeeAvery/Repos/AveryOS_PublicTerminal_Launch2026.aoscap",
              "version": "1.0.0"
            },
            "deployment": {
              "timestamp": "${TIMESTAMP}",
              "commit": "${COMMIT_SHA}",
              "message": "${COMMIT_MSG}",
              "branch": "main"
            },
            "security": {
              "vaultChainAnchor": "cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e",
              "driftProtection": "ABSOLUTE",
              "capsuleEcho": true
            }
          }
          EOF
          
          echo "âœ“ Capsule metadata generated"
          cat capsule_metadata.json

      - name: Sync Capsule with Registry
        run: |
          echo "ðŸ”„ Preparing capsule registry sync..."
          echo "Note: Registry sync is currently disabled (placeholder)"
          echo "To enable, configure the AveryOS_CapsulePushToken_v2 secret"
          echo "and uncomment the curl command in this workflow step"
          # Uncomment the following lines when registry API is configured:
          # curl -X POST https://vaultchain.api/register-capsule \
          #   -H "Authorization: Bearer ${{ secrets.AveryOS_CapsulePushToken_v2 }}" \
          #   -H "Content-Type: application/json" \
          #   -d @capsule_metadata.json
          echo "âœ“ Workflow completed (registry sync disabled)"
      
      - name: Push Notification
        if: success()
        run: |
          echo "âœ… Capsule update pushed successfully!"
          echo "â›“ï¸âš“â›“ï¸"
          echo "Timestamp: $(date -u)"
      
      - name: Push Failed
        if: failure()
        run: |
          echo "âŒ Capsule push failed"
          echo "Check logs above for details"
